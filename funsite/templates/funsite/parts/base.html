## mako
<%!
from django.core.urlresolvers import reverse
from django.utils.translation import ugettext as _

from staticfiles.storage import staticfiles_storage

%>


<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <%block name="meta_extra" />
    <link href='http://fonts.googleapis.com/css?family=Raleway:200,300,400,500,700,600,800,900' rel='stylesheet' type='text/css'>

    <link href="${staticfiles_storage.url('funsite/bootstrap/css/bootstrap.min.css')}" rel="stylesheet">
    <link rel="stylesheet" href="${staticfiles_storage.url('OwlCarousel2/dist/assets/owl.carousel.min.css')}">
    <link rel="stylesheet" href="${staticfiles_storage.url('OwlCarousel2/dist/assets/owl.theme.default.min.css')}">

    <!--
        <link href="${staticfiles_storage.url('bootstrap-big-grid/dist/css/bootstrap-big-grid.min.css')}" rel="stylesheet">
    -->
    <link href="${staticfiles_storage.url('funsite/css/fun.css')}" rel="stylesheet">


    <title><%block name="title" /></title>

    <!-- Bootstrap -->

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <style>
    </style>

</head>
<body>


<div class="main-width">

    <%include file="menu.html" />

    <div class="container-fluid drop-down">


    <%block name="content"></%block>


    <%include file="footer.html" />



    </div> <!-- bootstrape container -->

</div>  <!-- main-width -->

<%include file="sandwich-overlay.html" />


    <script src="${staticfiles_storage.url('jquery/dist/jquery.min.js')}"></script>
    <script src="${staticfiles_storage.url('funsite/bootstrap/js/bootstrap.min.js')}"></script>
    <script src="${staticfiles_storage.url('OwlCarousel2/dist/owl.carousel.min.js')}"></script>
    <script type="text/javascript" src="${staticfiles_storage.url("js/vendor/require.js")}"></script>
    <script type="text/javascript" src="${staticfiles_storage.url("require-config-lms.js")}"></script>
    <script>
        require.config({paths: {
                underscore: '/static/js/vendor/underscore-min',
                backbone: '/static/js/vendor/backbone-min',
            }});
    </script>

    <script type="text/javascript" src="/jsi18n/"></script>
    <%block name="js_extra" />

    <script>
    (function() {
        $(document).keydown(function(event) {
            if (event.keyCode == 27) { // ESC key
                $('.hide-on-escape-key:visible').hide();
            }
        });

        /* Sandwich menu handler */
        $('.close-overlay').on('click', function(event) {
            $(this).parent().hide()
        });

        $('#sandwich-menu').on('click', function(event) {
            $('#sandwich-overlay').show();
        });

        /* login overlay */
        $('#top-menu .connexion.not-connected').on('click', function(event) {
            $('#login-overlay').show();
        });

        $('#login-form').on('submit', function(event) {
            event.preventDefault();
            $.ajax({
                url: '/login_ajax',
                method: 'POST',
                data: $(this).serialize(),
                success: function(json){
                    if (json.success) {
                        var u = decodeURI(window.location.search);
                        var next = u.split("next=")[1];
                        if (next != undefined) {
                            // if next is undefined, decodeURI returns "undefined" causing a bad redirect.
                            next = decodeURIComponent(next);
                        }
                        if (next && !isExternal(next)) {
                            location.href=next;
                        }  else if (json.redirect_url) {
                            location.href=json.redirect_url;
                        } else {
                            location.href="${reverse('dashboard')}";
                        }
                    } else if (json.hasOwnProperty('redirect')) {
                        var u = decodeURI(window.location.search);
                        if (!isExternal(json.redirect)) { // a paranoid check.  Our server is the one providing json.redirect
                            location.href=json.redirect+u;
                        } // else we just remain on this page, which is fine since this particular path implies a login failure
                    // that has been generated via packet tampering (json.redirect has been messed with).
                    } else {
                        $('#login-overlay').find('input').addClass('loginerror');
                        $('#login-overlay').find('.error').html(json.value)
                    }

                },
                error: function(response) {
                    $('#login-overlay').find('input').addClass('loginerror');
                    $('#login-overlay').find('.error').html(gettext("Your request could not be completed. Please try again"));
                }
            });
        })

    })();

    </script>


  </body>
</html>